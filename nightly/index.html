<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <style type="text/css">
      .nested-border > .table-bordered:first-child {
        border-top:0;
        border-top-style: none;
      }
    </style>

    <title>Amazon Corretto nightly build downloads</title>
  </head>
  <body>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.min.js" integrity="sha384-7VPbUDkoPSGFnVtYi0QogXtr74QeVeeIs99Qfg5YCF+TidwNdjvaKZX19NZ/e6oz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js" integrity="sha512-T/tUfKSV1bihCnd+MxKD0Hm1uBBroVYBOYSk1knyvQ9VyZJpc/ALb4P0r6ubwVPSGB2GvjeoMAJJImBG12TiaQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" integrity="sha512-Oy+sz5W86PK0ZIkawrG0iv7XwWhYecM3exvUtMKNJMekGFJtVAhibhRPTpmyTj8+lJCkmWfnpxKgT2OopquBHA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <div class="container">
      <h1 class="text-center">Amazon Corretto nightly build downloads</h1>
      <p>
        Amazon Corretto provides nightly builds for evaluation and testing purposes. These builds may contain bugs or breaking changes in functionality and are not supported in production environments.
        For the latest supported releases please visit <a href="https://corretto.aws">Corretto.aws</a> for download and installation instructions.
      </p>
      <div class='input-group date' id='datepicker' style="justify-content: center"><p>Showing builds for
        <input type="text" value="" size="12">
        <span class="input-group-addon"><span class="bi bi-calendar3"></span></span>
        </p>
    </div>

    <div class="container">
      <p>
      <div class="row">
        <div class="col">
          <select id="versionSelect" class="form-select required" onchange="onSelectChange()"> <option selected>All Versions</option></select>
        </div>
        <div class="col">
          <select id="platformSelect" class="form-select required" onchange="onSelectChange()"> <option selected>All Platforms</option></select>
        </div>
        <div class="col">
          <select id="architectureSelect" class="form-select required" onchange="onSelectChange()"> <option selected>All Architectures</option></select>
        </div>
      </div>
      </p>
    </div>

    <div class="container" style="background-color:white;color: black;" id="target"></div>
    <script type="text/javascript">

      function onSelectChange() {
        buildPage(jsonText, true);
      };

      // Compare function for getting order Corretto versions.
      // Strips off the "Corretto" from CorrettoXX so 8 is 1st.
      function correttoCompare(a, b) {
          a_ver=Number(a.slice(8));
          b_ver=Number(b.slice(8));
          if(a_ver < b_ver) return -1;
          if(a_ver > b_ver) return 1;
          return 0;
        };

      $(function () {
            $('#datepicker').datepicker({
              format: 'yyyy-mm-dd',
              autoclose: true,
            }).on('changeDate', function(e) {
              const corretto_domain = 'https://corretto.aws';
              const new_url = corretto_domain + '/nightly/' + e.date.getFullYear() + '/' + ("0" + (e.date.getMonth() + 1)).slice(-2) + '/' + ("0" + e.date.getDate()).slice(-2) + '/manifest.json';
              $(this).datepicker('hideWidget');
              console.log(new_url);
              loadJSON(new_url);
            })
          });
      function loadJSON(url) {
        var xhttp;
        xhttp=new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            jsonText = xhttp.responseText
            buildPage(jsonText, false);
          } else {
            $('#target').html('No builds available for selected date.');
          }
        };
        xhttp.open("GET", url, true);
        xhttp.send();
      }
      function buildPage(jsonText, is_rebuild) {
        const corretto_domain = 'https://corretto.aws';
        var data = JSON.parse(jsonText);
        $('#datepicker').datepicker('update', data.date);

        const select_version = document.getElementById('versionSelect');
        const select_platform = document.getElementById('platformSelect');
        const select_architecture = document.getElementById('architectureSelect');

        const known_versions = new Set()
        const known_platforms = new Set()
        const known_architectures = new Set()
        $html = '';
        $html += '<table class="table table-bordered table-striped">'
        $html += '<thead>'
        $html += '<tr>'
        $html += '<th scope="col">Version</th>'
        $html += '<th scope="col">Branch</th>'
        $html += '<th scope="col">Commit</th>'
        $html += '<th scope="col">Debug Level</th>'
        $html += '<th scope="col">Platform</th>'
        $html += '<th scope="col">Architecture</th>'
        $html += '<th scope="col">Artifacts</th>'
        $html += '</tr></thead>'
        $html += '<tbody>'
        for (const version of Object.keys(data.versions).sort(correttoCompare)) {
          // Index 0 is the "All Versions entry", when it is selected no filtering is done.
          if (select_version.selectedIndex != 0 && select_version.options[select_version.selectedIndex].value != version) {
            continue;
          }
          known_versions.add(version);
          for (branch in data.versions[version].branches) {
            for (commit in data.versions[version].branches[branch].commits) {
              for (debug_level in data.versions[version].branches[branch].commits[commit].debug_levels) {
                for (platform in data.versions[version].branches[branch].commits[commit].debug_levels[debug_level].platforms) {
                  if (select_platform.selectedIndex != 0 && select_platform.options[select_platform.selectedIndex].value != platform) {
                      continue;
                  }
                  known_platforms.add(platform);
                  for (arch in data.versions[version].branches[branch].commits[commit].debug_levels[debug_level].platforms[platform].architectures) {
                    architecture = data.versions[version].branches[branch].commits[commit].debug_levels[debug_level].platforms[platform].architectures[arch];
                    if (select_architecture.selectedIndex != 0 && select_architecture.options[select_architecture.selectedIndex].value != arch) {
                      continue;
                    }
                    known_architectures.add(arch);
                    for (i in architecture.build.artifacts) {
                      const mv = version.slice(8)

                      $html += `<tr><td class="nested-border">${version}</td>`;
                      $html += `<td class="nested-border"><a href="https://github.com/corretto/corretto-${mv}/tree/${branch}" target="_blank">${branch}</a></td>`;
                      $html += `<td class="nested-border"><a href="https://github.com/corretto/corretto-${mv}/commit/${commit}" target="_blank">${commit.substring(0, 12)}</a></td>`;
                      $html += `<td class="nested-border">${debug_level}</td>`;
                      $html += `<td class="nested-border">${platform}</td>`;
                      $html += `<td class="nested-border">${arch}</td>`;

                      artifact = architecture.build.artifacts[i];
                      $html += `<td class="nested-border"><div><span><a class="badge rounded-pill bg-primary" href="${corretto_domain}/${artifact.location}/${artifact.filename}" target="_blank">${artifact.type}</a></span>`;
                      for (hash in artifact.hashes) {
                        $html += `<span> <a class="badge rounded-pill bg-secondary" href="${corretto_domain}/${artifact.location}/${artifact.hashes[hash]}" target="_blank">${hash}</a></span>`;
                      }
                      $html += '</div>';
                    }
                    $html += '<div class="col">';
                    for (i in architecture.build.test_results) {
                      test_result = architecture.build.test_results[i];

                      $html += `<span> <a class="badge rounded-pill bg-success" href="${corretto_domain}/${artifact.location}/${test_result}">${test_result.split('/')[1]}</a></span>`;
                    }
                    $html += '</td>';
                  }
                }
              }
            }
          }
        }
        $html += '</tbody></table>'

        if (!is_rebuild) {
          select_version.options.length = 1;
          known_versions.forEach((version) => select_version.add(new Option(version, version)));
          select_platform.options.length = 1;
          known_platforms.forEach((platform) => select_platform.add(new Option(platform, platform)));
          select_architecture.options.length = 1;
          known_architectures.forEach((architecture) => select_architecture.add(new Option(architecture, architecture)));
        }
        $('#target').empty();
        $('#target').html($html);
      }

      url = 'https://corretto.aws/nightly/latest/manifest.json'
      loadJSON(url);
    </script>
    <hr class="solid">

    <div>
      <br><h4>Branch descriptions</h4>
      <dl class="row">
        <dt>develop</dt> <dd>Tracks OpenJDK Update repository where stabilization for releases happens.</dd>
        <dt>nightly</dt>
        <dd>Tracks OpenJDK Update-dev repository, that contains the latest committed code.</dd>
        <dt>generational-shenandoah</dt>
        <dd>Includes experimental <a href="https://aws.amazon.com/blogs/developer/announcing-preview-release-for-the-generational-mode-to-the-shenandoah-gc/">Generational Shenadoah</a> garbage collector.</dd>
      </dl>
    </div>

    <div>
      <h4>Notes</h4>
      <ul>
      <li>If you do not see any builds for a date, particular OS or architecture for a given date, the build may have been disabled, cancelled or failed. Builds are provided as a best effort.</li>
      <li>TAP files contain just the pass/fail informaton regarding the various test suites run for a build.</li>
      </ul>
    </div>

    <div>
      <br><h4>Disclaimer</h4> Links are provided for testing/evaluation purposes only and should not be used for production. They contain the latest development code which may contain bugs.
    </div>
  </body>
</html>